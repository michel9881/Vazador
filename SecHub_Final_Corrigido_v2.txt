--[[
 ‚úÖ sec hub - VERS√ÉO FINAL CORRIGIDA (loading restaurado)
 - Todas as fun√ß√µes do script original mantidas (bring, headsit, view, casas, noclip, campainha, etc.)
 - Corrigidos AddSection, AddParagraph, ClearDropdown inv√°lidos
 - Adicionados pcall() para evitar travar execu√ß√£o
 - loadstring protegido: s√≥ funciona em executor externo (n√£o no Studio)
]]

-- Tela de carregamento
local playerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
local loadingGui = Instance.new("ScreenGui", playerGui)
loadingGui.Name = "SecHubLoading"
loadingGui.ResetOnSpawn = false
loadingGui.IgnoreGuiInset = true

local background = Instance.new("Frame", loadingGui)
background.Size = UDim2.new(1, 0, 1, 0)
background.Position = UDim2.new(0, 0, 0, 0)
background.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
background.BorderSizePixel = 0
background.ZIndex = 1

local frame = Instance.new("Frame", background)
frame.Size = UDim2.new(0, 400, 0, 120)
frame.Position = UDim2.new(0.5, 0, 0.5, 0)
frame.AnchorPoint = Vector2.new(0.5, 0.5)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.ZIndex = 2

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0.4, 0)
title.Position = UDim2.new(0, 0, 0, 0)
title.Text = "sec hub carregando..."
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.ZIndex = 3

local percentLabel = Instance.new("TextLabel", frame)
percentLabel.Size = UDim2.new(1, 0, 0.3, 0)
percentLabel.Position = UDim2.new(0, 0, 0.4, 0)
percentLabel.Text = "0%"
percentLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
percentLabel.BackgroundTransparency = 1
percentLabel.Font = Enum.Font.Gotham
percentLabel.TextScaled = true
percentLabel.ZIndex = 3

local progressBar = Instance.new("Frame", frame)
progressBar.Size = UDim2.new(0, 0, 0.2, 0)
progressBar.Position = UDim2.new(0, 0, 0.8, 0)
progressBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
progressBar.BorderSizePixel = 0
progressBar.ZIndex = 3

local duration = 10
local steps = 100
local interval = duration / steps

for i = 1, steps do
    percentLabel.Text = i .. "%"
    progressBar.Size = UDim2.new(i / 100, 0, 0.2, 0)
    wait(interval)
end

loadingGui:Destroy()

-- Servi√ßos e vari√°veis
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then return end

-- Helper notifica√ß√µes
local function notify(t, msg, dur)
    pcall(function()
        StarterGui:SetCore("SendNotification", { Title = t, Text = msg, Duration = dur or 3 })
    end)
end

-- Carregar RedzLib (stub fallback se falhar)
local RedzLib
local ok, lib = pcall(function()
    local src = game:HttpGet("https://raw.githubusercontent.com/tbao143/Library-ui/refs/heads/main/Redzhubui")
    local fn = loadstring(src)
    return fn()
end)
if ok and lib then
    RedzLib = lib
else
    RedzLib = {}
    function RedzLib:MakeWindow(o)
        local t = {}
        function t:AddMinimizeButton() end
        function t:MakeTab(tt)
            local tab = {}
            function tab:AddSection() end
            function tab:AddParagraph() end
            function tab:AddButton() end
            function tab:AddToggle() end
            function tab:AddTextBox() end
            function tab:AddDropdown() return { Add=function() end, Remove=function() end, Set=function() end, SetValue=function() end } end
            return tab
        end
        return t
    end
end

-- Criar janela
local Window = RedzLib:MakeWindow({
    Title = "sec hub‚úî - Brookhaven Premium",
    SubTitle = "vers√£o final",
    LoadText = "sec hub iniciado",
    Flags = "SecHub_Final"
})
pcall(function()
    Window:AddMinimizeButton({})
end)

-- OP TAB
local OpTab = Window:MakeTab({ Title = "Op", Icon = "rbxassetid://6023426922" })
pcall(function() OpTab:AddSection({ Name = "Ferramentas de Teleporte" }) end)
pcall(function()
    OpTab:AddButton({
        Name = "Bring Script",
        Callback = function()
            local ok2, err = pcall(function()
                local code = game:HttpGet("https://raw.githubusercontent.com/sukuna355/testeismail333/refs/heads/main/Protected_8660142218887189.lua")
                local fn = loadstring(code)
                if fn then fn() end
            end)
            if not ok2 then warn("Erro bring:", err) end
        end
    })
end)

-- HEADSIT
pcall(function() OpTab:AddSection({ Name = "Headsit" }) end)
local selectedPlayerName_headsit = nil
local headsitActive = false

local function findPlayerByPartialName(partial)
    if not partial then return nil end
    partial = partial:lower()
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Name:lower():sub(1, #partial) == partial then return plr end
    end
    return nil
end

local function headsitOnPlayer(plr)
    if not plr or not plr.Character or not plr.Character:FindFirstChild("Head") then return false end
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return false end
    root.CFrame = plr.Character.Head.CFrame * CFrame.new(0, 2.2, 0)
    for _, v in pairs(root:GetChildren()) do if v:IsA("WeldConstraint") then v:Destroy() end end
    local weld = Instance.new("WeldConstraint", root)
    weld.Part0 = root
    weld.Part1 = plr.Character.Head
    if character:FindFirstChildOfClass("Humanoid") then character:FindFirstChildOfClass("Humanoid").Sit = true end
    notify("Headsit", "Voc√™ sentou em " .. plr.Name)
    return true
end

local function removeHeadsit()
    local character = LocalPlayer.Character
    if character then
        local root = character:FindFirstChild("HumanoidRootPart")
        if root then
            for _, v in pairs(root:GetChildren()) do if v:IsA("WeldConstraint") then v:Destroy() end end
        end
        if character:FindFirstChildOfClass("Humanoid") then character:FindFirstChildOfClass("Humanoid").Sit = false end
    end
end

pcall(function()
    OpTab:AddTextBox({
        Name = "Selecionar Jogador",
        PlaceholderText = "Digite nome...",
        Callback = function(val)
            local plr = findPlayerByPartialName(val)
            if plr then selectedPlayerName_headsit = plr.Name; notify("Player", "Selecionado " .. plr.Name) end
        end
    })
end)
pcall(function()
    OpTab:AddButton({
        Name = "Toggle Headsit",
        Callback = function()
            if not selectedPlayerName_headsit then return end
            local plr = Players:FindFirstChild(selectedPlayerName_headsit)
            if not headsitActive then headsitActive = headsitOnPlayer(plr) else removeHeadsit(); headsitActive = false end
        end
    })
end)

-- VIEW
pcall(function() OpTab:AddSection({ Name = "Vis√£o de Jogadores" }) end)
local playersList = {}
for _, plr in pairs(Players:GetPlayers()) do if plr ~= LocalPlayer then table.insert(playersList, plr.Name) end end
local selectedView = nil
local viewDropdown = OpTab:AddDropdown({ Name = "Selecionar", Options = playersList, Callback = function(v) selectedView = v end })
pcall(function()
    OpTab:AddToggle({
        Name = "üëÅ Ver jogador",
        Callback = function(state)
            local cam = workspace.CurrentCamera
            if state and selectedView then
                local plr = Players:FindFirstChild(selectedView)
                if plr and plr.Character and plr.Character:FindFirstChild("Humanoid") then cam.CameraSubject = plr.Character.Humanoid end
            else
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then cam.CameraSubject = LocalPlayer.Character.Humanoid end
            end
        end
    })
end)
Players.PlayerAdded:Connect(function(plr) pcall(function() viewDropdown:Add(plr.Name) end) end)
Players.PlayerRemoving:Connect(function(plr) pcall(function() viewDropdown:Remove(plr.Name) end) end)

-- CASAS TAB
local CasasTab = Window:MakeTab({ Title = "Casas", Icon = "home" })
pcall(function() CasasTab:AddSection({ Name = "Gerenciar Casas" }) end)
local selectedHouse = nil

local function getHouseList()
    local list = {}
    local lots = workspace:FindFirstChild("001_Lots")
    if lots then for _, h in pairs(lots:GetChildren()) do if h:IsA("Model") and h.Name ~= "For Sale" then table.insert(list, h.Name) end end end
    return list
end

local houseDropdown = CasasTab:AddDropdown({ Name = "Selecione Casa", Options = getHouseList(), Callback = function(v) selectedHouse = v end })
pcall(function()
    CasasTab:AddButton({ Name = "Atualizar", Callback = function() pcall(function() if houseDropdown.Set then houseDropdown:Set(getHouseList()) end end) end })
end)
pcall(function()
    CasasTab:AddButton({ Name = "Teleportar Casa", Callback = function()
        local h = workspace["001_Lots"] and workspace["001_Lots"]:FindFirstChild(selectedHouse or "")
        if h and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(h.WorldPivot.Position) end
    end })
end)
pcall(function()
    CasasTab:AddButton({ Name = "Teleportar Cofre", Callback = function()
        local h = workspace["001_Lots"] and workspace["001_Lots"]:FindFirstChild(selectedHouse or "")
        if h and h:FindFirstChild("HousePickedByPlayer") then
            local safe = h.HousePickedByPlayer.HouseModel:FindFirstChild("001_Safe")
            if safe and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(safe.WorldPivot.Position) end
        end
    end })
end)
pcall(function()
    CasasTab:AddToggle({ Name = "Atravessar Porta", Callback = function(v)
        local h = workspace["001_Lots"] and workspace["001_Lots"]:FindFirstChild(selectedHouse or "")
        if h and h:FindFirstChild("HousePickedByPlayer") then
            local doors = h.HousePickedByPlayer.HouseModel:FindFirstChild("001_HouseDoors")
            if doors and doors:FindFirstChild("HouseDoorFront") then
                for _, d in pairs(doors.HouseDoorFront:GetChildren()) do if d:IsA("BasePart") then d.CanCollide = not v end end
            end
        end
    end })
end)
pcall(function()
    CasasTab:AddToggle({ Name = "Campainha Loop", Callback = function(v)
        getgenv().DoorbellLoop = v
        task.spawn(function()
            while getgenv().DoorbellLoop do
                local h = workspace["001_Lots"]:FindFirstChild(selectedHouse or "")
                if h and h:FindFirstChild("Doorbell") then
                    pcall(function() fireclickdetector(h.Doorbell.ClickDetector) end)
                end
                task.wait(2)
            end
        end)
    end })
end)

notify("sec hub", "Script carregado com sucesso!", 5)
